<?php declare(strict_types=1);

namespace helena\tests\spatialdb;

use minga\framework\Str;
use helena\classes\TestCase;
use helena\classes\App;

class SpatialTestBase extends TestCase
{
	// Ayuda para crear geometrías:
	// http://arthur-e.github.io/Wicket/sandbox-gmaps3.html

	protected function evaluateSet($geometries, $dbFunction, $result, $resultAsText = false)
	{
		$selects = [];
		foreach($geometries as $geometry)
		{
			if (Str::StartsWith("" . $result, "["))
				$expected = $geometry[Str::Replace(Str::Replace($result, "]", ""), "[", "")];
			else
				$expected = $result;
			if (is_numeric($expected))
			{
				$expected = number_format ($expected, 6, ".", "");
			}
			if ($resultAsText)
			{
				$preparedFunction = "AsText(" . $dbFunction . "(";
				$closing = "))";
			}
			else
			{
				$preparedFunction = $dbFunction . "(";
				$closing = ")";
			}
			$query = "SELECT " . Str::CheapSqlEscape($geometry['Name']) . " Name,
									" . Str::CheapSqlEscape($dbFunction) . " Function,
									" . $preparedFunction . "ST_GeomFromText(". Str::CheapSqlEscape($geometry['Geometry']) . ")" . $closing . " Result,
									" . Str::CheapSqlEscape($expected) . " Expected";
			$selects[] = $query;
		}
		$sql = implode(' UNION ALL ', $selects);

		$rows = App::Db()->fetchAll($sql);
		foreach($rows as $row)
		{
			if (is_numeric($row['Result']) && is_numeric($row['Expected']) &&
						abs($row['Result'] - $row['Expected']) < 0.0001)
				$row['Result'] = $row['Expected'];

			$this->assertEquals($row['Expected'], $row['Result'], $row['Function'] . " falló en " . $row['Name']);
		}
	}

	protected function getPolygons()
	{
		$ret = [
						["Name" => "SALTA",
						 "Geometry" => "POLYGON((-68.36986937985536 -25.250353844530014,-68.54565062985536 -24.772464473786084,-68.36986937985536 -24.492841237347942,-68.01830687985536 -24.2927285617427,-67.35912719235536 -24.012040432868524,-67.18334594235536 -23.650254390563454,-66.51317992673036 -24.06220849404078,-66.31542602048036 -23.398423143687758,-65.86498656735536 -23.529435529103008,-65.77709594235536 -24.132410832884055,-64.59057250485536 -24.572797402458725,-64.32690062985536 -24.212594912137266,-64.15111937985536 -23.569720841593618,-65.07397094235536 -23.327824232774333,-65.33764281735536 -22.477734844516803,-65.07397094235536 -22.11179429189175,-64.50268187985536 -22.274552819755197,-64.30492797360536 -22.77181945551468,-63.83251586423036 -21.999788644513448,-62.78881469235536 -21.989601917478915,-62.30541625485536 -22.8022060225238,-62.38232055173036 -24.46284455520497,-63.49193969235536 -25.686774741341214,-63.99731078610536 -25.716472919229723,-64.28295531735536 -25.884622410162017,-64.50268187985536 -26.190631595680614,-65.20580687985536 -26.279323089845416,-65.62878051266786 -26.08213912290558,-65.74139037594911 -26.299023117176336,-66.15063109860536 -26.170913191681507,-66.40331664548036 -26.338413129248988,-66.81530395016786 -25.76100628667646,-66.43627562985536 -25.36953460361521,-66.84276977048036 -25.24041682612821,-67.24926391110536 -25.270225442817615,-67.84527221188661 -25.25532204895998,-68.36986937985536 -25.250353844530014))",
						 "Area" => 160851656871.1719,
						 "Perimeter" => 2489622.7115452,
						 "Centroid" => 'POINT(-64.85448318895097 -24.298335671038522)'],
						["Name" => "SALTA SIN LAGUNA (polígono con agujero)",
						 "Geometry" => "POLYGON((-68.36986937985536 -25.250353844530014,-68.54565062985536 -24.772464473786084,-68.36986937985536 -24.492841237347942,-68.01830687985536 -24.2927285617427,-67.35912719235536 -24.012040432868524,-67.18334594235536 -23.650254390563454,-66.51317992673036 -24.06220849404078,-66.31542602048036 -23.398423143687758,-65.86498656735536 -23.529435529103008,-65.77709594235536 -24.132410832884055,-64.59057250485536 -24.572797402458725,-64.32690062985536 -24.212594912137266,-64.15111937985536 -23.569720841593618,-65.07397094235536 -23.327824232774333,-65.33764281735536 -22.477734844516803,-65.07397094235536 -22.11179429189175,-64.50268187985536 -22.274552819755197,-64.30492797360536 -22.77181945551468,-63.83251586423036 -21.999788644513448,-62.78881469235536 -21.989601917478915,-62.30541625485536 -22.8022060225238,-62.38232055173036 -24.46284455520497,-63.49193969235536 -25.686774741341214,-63.99731078610536 -25.716472919229723,-64.28295531735536 -25.884622410162017,-64.50268187985536 -26.190631595680614,-65.20580687985536 -26.279323089845416,-65.62878051266786 -26.08213912290558,-65.74139037594911 -26.299023117176336,-66.15063109860536 -26.170913191681507,-66.40331664548036 -26.338413129248988,-66.81530395016786 -25.76100628667646,-66.43627562985536 -25.36953460361521,-66.84276977048036 -25.24041682612821,-67.24926391110536 -25.270225442817615,-67.84527221188661 -25.25532204895998,-68.36986937985536 -25.250353844530014),(-68.36986937985536 -25.170353844530013,-67.84252562985536 -25.000834959540995,-67.24926391110536 -25.170225442817614,-68.36986937985536 -25.170353844530013))",
						 "Area" => 1070272272.6115512,
						 "Perimeter" => 2489622.711545239,
						 "Centroid" => 'POINT(-64.83463081916881 -24.29287760873512)'],
					["Name" => "Parque Centenario (CABA)",
						 "Geometry" => "POLYGON((-58.4381618306285 -34.60553915985753,-58.43663833590804 -34.60458543811881,-58.434835891450035 -34.60460309973203,-58.433612804139244 -34.605344884095445,-58.43292615863143 -34.60666948254877,-58.433376769745934 -34.607817450782996,-58.43447111102401 -34.60850622410528,-58.436616878235924 -34.60857686719988,-58.43766830416976 -34.607817450782996,-58.43846223803817 -34.60654585425383,-58.4381618306285 -34.60553915985753))",
						 "Area" => 171249.0700085798,
						 "Perimeter" => 1498.3658780174953,
						 "Centroid" => 'POINT(-58.43567958039791 -34.6065829834913)'],
					["Name" => "Parque Sarmiento (CABA)",
						 "Geometry" => "POLYGON((-58.49903072170638 -34.56488731865751,-58.496455801052086 -34.56319097616349,-58.49611247829818 -34.556829383663064,-58.5000606899681 -34.55173975936767,-58.504008901638024 -34.56050502978693,-58.49903072170638 -34.56488731865751))",
						 "Area" => 628276.8460472985,
						 "Perimeter" => 3388.432350365575,
						 "Centroid" => 'POINT(-58.49954723577865 -34.558912509764646)']
						];
		return $ret;
	}

	protected function getPoints()
	{
		$ret = [
						["Name" => "Glaciar Perito Moreno",
						 "Geometry" => "POINT(-73.137661 -50.496708)",
						 "Centroid" => "POINT(-73.137661 -50.496708)"],
						["Name" => "Las Grutas",
						 "Geometry" => "POINT(-65.09531952600474 -40.80834269139358)",
						 "Centroid" => "POINT(-65.09531952600474 -40.80834269139358)"],
						["Name" => "Antofagasta de la Sierra",
						 "Geometry" => "POINT(-67.40592409102251 -26.06291797968842)",
						 "Centroid" => "POINT(-67.40592409102251 -26.06291797968842)"]
						 ];
		return $ret;
	}

	protected function getLineStrings()
	{
		$ret = [
						["Name" => "Calle Florida",
						 "Geometry" => "LINESTRING(-58.37443519616553 -34.594889740151324,-58.373619804625 -34.60803047625951)",
						 "Perimeter" => 1463.0879856237548,
						 "Centroid" => 'POINT(-58.374027500395265 -34.601460108205416)'],
						["Name" => "Autopista Perito Moreno",
						 "Geometry" => "LINESTRING(-58.52987990561515 -34.634669810930845,-58.5219834822753 -34.63721212280478,-58.51134047690421 -34.634669810930845,-58.50636229697257 -34.636082216036705,-58.49829421225577 -34.635940976608396,-58.49262938681632 -34.639613123577845,-58.4890244979003 -34.64413246587551,-58.4780381697753 -34.64836912558308,-58.46636519614249 -34.649498864942366)",
						 "Perimeter" => 6455.721424660705,
						 "Centroid" => 'POINT(-58.497933969917085 -34.6405837543423)'],
						["Name" => "Buenos Aires - Tandil",
						 "Geometry" => "LINESTRING(-58.63605612448318 -34.60564003701776,-58.62506979635818 -34.80433943086879,-58.76239889792068 -35.02955409552928,-58.74042624167068 -35.20928034639045,-58.81183737448318 -35.40652070851367,-58.82282370260818 -35.44680605145543,-58.87226217917068 -35.47365175048871,-58.83930319479568 -35.634537675315194,-58.93818014792068 -35.7594477610433,-58.92170065573318 -35.870809176035415,-59.10297506979568 -36.07752555043,-59.04804342917068 -36.21503544433632,-59.04804342917068 -36.294769213492415,-58.99860495260818 -36.38768904781717,-59.07001608542068 -36.62611618029437,-59.04804342917068 -36.79785637764657,-58.98761862448318 -36.86380803151696,-59.02057760885818 -37.15331912769615,-59.16889303854568 -37.28892065465476,-59.09748190573318 -37.32824316222781)",
						 "Perimeter" => 330081.1918021253,
						 "Centroid" => 'POINT(-58.922276197198826 -35.99865577367009)']
						 ];
		return $ret;
	}

	protected function getMultiLineStrings()
	{
		$ret = [
						["Name" => "Líneas B y D de Subterráneo (CABA)",
							"Geometry" => "MULTILINESTRING((-58.48309377775228 -34.57239299705091,-58.47279409513509 -34.5783293873872,-58.46009115324056 -34.58539596599056,-58.44464162931478 -34.59302719598563,-58.440178433514 -34.599244717003096,-58.42163900480306 -34.60263589594665,-58.39279989347494 -34.60433143349194,-58.374603787517906 -34.60461401971714),(-58.372887173748374 -34.60814626639309,-58.38576177701986 -34.6015055183509,-58.402069607830406 -34.59302719598563,-58.41975072965658 -34.58214541445741,-58.44258169279134 -34.57083815810285,-58.46112112150228 -34.55797428435304,-58.47691396818197 -34.53874544581191))",
						 "Perimeter" => 23474.56817303111,
						 "Centroid" => 'POINT(-58.42916550905669 -34.585654444666716)']
						];
		return $ret;
	}

	protected function getMultiPolygons()
	{
		$ret = [
						["Name" => "Parques Sarmiento y Centenario (CABA)",
						 "Geometry" => "MULTIPOLYGON(((-58.49903072170638 -34.56488731865751,-58.496455801052086 -34.56319097616349,-58.49611247829818 -34.556829383663064,-58.5000606899681 -34.55173975936767,-58.504008901638024 -34.56050502978693,-58.49903072170638 -34.56488731865751)),((-58.4381618306285 -34.60553915985753,-58.43663833590804 -34.60458543811881,-58.434835891450035 -34.60460309973203,-58.433612804139244 -34.605344884095445,-58.43292615863143 -34.60666948254877,-58.433376769745934 -34.607817450782996,-58.43447111102401 -34.60850622410528,-58.436616878235924 -34.60857686719988,-58.43766830416976 -34.607817450782996,-58.43846223803817 -34.60654585425383,-58.4381618306285 -34.60553915985753)))",
						 "Area" => 799525.9160558783,
						 "Perimeter" => 4886.798228383071,
						 "Centroid" => 'POINT(-58.485861394548245 -34.569127547891725)']
						];
		return $ret;
	}
}

